<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<title>Главная</title>
	<meta name="" content="">
	<link type="text/css" rel="stylesheet" href="css/style.css">
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script src="raphael-min.js" type="text/javascript"></script>

</head>
<body onload="generate_table()">
	<script> 
		
	
		function generate_table(){
			//считываем количество строк и столбцов для шахматной доски
			colum_count=document.getElementById("column").value;
			line_count=document.getElementById("line").value;
			
			//очищаем доску от элементов, если таковые есть
			if ($('svg')) {
				$('svg').remove();
			}
			//создаем массив шашек
			var arr_check = new Array();

			 
			//создание доски
			var table = '<table class="table-desk">'; // таблица (доска)
 			//строки
			for (i = 0; i < line_count; i++) {
    			table = table +'<tr>';		
				arr_check[i] = new Array();				
				//столбцы
    				for (j = 0; j < colum_count; j++) {
						if (((i % 2 == 0)&&(j % 2 == 0))||((i % 2 == 1)&&(j % 2 == 1))){
							table = table +'<td class="dark" id = "'+i+j+'"></td>';
					    } else {
							table = table +'<td class="lite" id = "'+i+j+'"></td>';
						}
					arr_check[i][j] = "n";
    				}
    				table = table + '</tr>';
			}
			table = table + '</table>';
			$('#desk').html(table);
			
			//Создание холста для шашек		
			var paper = Raphael($("#00").offset().left, $("#00").offset().top, colum_count*50+colum_count*4, line_count*50+line_count*4);
			
			//объединение в группы
			var stblack = paper.set();
			var stred = paper.set();
			
			//Количество красных шашек
			r_count = 0;	
			
			//строки
			for (i = 0; i < line_count; i++) { 				
					//столбцы			
    				for (j = 0; j < colum_count; j++) {
						if (((i % 2 == 0)&&(j % 2 == 0))||((i % 2 == 1)&&(j % 2 == 1))){
							if (i<line_count/2-1){	
								//номер строки (столбца) * на ширину ячейки + номер * ширину обводки
								// расстановка шашек
								stred.push (paper.circle(j*50+25+j*4,i*50+25+i*2, 20));
								arr_check[j][i]="r";
								r_count++;
							} else if(i>line_count/2){						
								stblack.push (paper.circle(j*50+25+j*4, i*50+25+i*2, 20));	
								arr_check[j][i]="b";
							}
						}						
    				}
			}
			//Количество черных шашек
			b_count = r_count;
			
			//установка начального счета
			document.getElementById("inr").innerHTML='<font color="red">' + r_count+'</font>:<font color="black">' + b_count+"</font>";
			
			//задание стиля шашек
			stblack.attr("fill", "black");
			stred.attr("fill", "red");
			
			//установление хода 
			move_b=true;
			
			//происходит по клику
			var start = function () {
                    this.ox = this.attr("cx");				
                    this.oy = this.attr("cy");
					
					//координаты клика
					ox = this.ox;
					oy = this.oy;

					//анимация на поднятие шашки r - радиус увеличиваем до 25 за 500 милисек
                    this.animate({r: 25}, 500, ">");
					
					//номер ячейки в массиве c которoй пошли
					 arr_oy = Math.floor(oy/52);
					 arr_ox = Math.floor(ox/54);
					 		
                },
                move = function (dx, dy) {
					//перемещение на передний план (поверх остальных шашек)
					this.toFront();
					//dx,dy текущее положение курсора
					//перемещение выбранного элемента
					this.attr({cx: this.ox + dx, cy: this.oy + dy});				 
                },
				
				//отпускаем элемент
                up = function () {
					var x=this.attr("cx");
					var y=this.attr("cy");
					//alert (x+" "+y);
					
					//номер ячейки на которую собираемся поставить шашку									
					var arr_y = Math.floor(y/52);
					var arr_x = Math.floor(x/54);
					
					//проверка на ход
					//this.attr("fill") - свойство заливка
					if ((move_b & this.attr("fill")=='black')|(!move_b & this.attr("fill")=='red')){
						//Запрет на выхождение за доску (лево/верх) - возвращается обратно
						if (arr_x<0 | arr_y<0 | arr_x > colum_count-1 | arr_y >line_count-1) {
							this.animate({r: 20, cx: ox, cy: oy}, 500, ">");
							return;
						}
						//проверка на цвет клетки
						if (((arr_x % 2 == 0)&&(arr_y % 2 != 0))||((arr_x % 2 == 1)&&(arr_y % 2 != 1))){
							alert ("Шашки ходят только на черные");
							this.animate({r: 20, cx: ox, cy: oy}, 500, ">");
							return;
						}
						//проверка на занятость клетки
						if (arr_check[arr_x][arr_y]!="n"){
							alert ("Клетка занята");
							this.animate({r: 20, cx: ox, cy: oy}, 500, ">");
							return;
						}
						
						//выравнивание по сетке 50 - ширина клетки, 25 - смещение на центр клетки, 4 (2) - промежуток между клетками
						x = arr_x*50+25+arr_x*4;
						y = arr_y*50+25+arr_y*2;
						
						
						//если съесть можно через одну
						if ((Math.abs(arr_oy-arr_y)==2 && Math.abs(arr_ox-arr_x)==2)){
							var eat_y;
							var eat_x;
							//координаты той, что едим
							if (arr_oy>arr_y){
								eat_y=arr_oy-1;
							} else{
								eat_y=arr_y-1;
							}
							if (arr_ox>arr_x){
								eat_x=arr_ox-1;
							} else{
								eat_x=arr_x-1;
							}
							
							//определяем шашку, которую едим
							elem = paper.getElementsByPoint(eat_x*54+25,eat_y*52+25)[0];

							//чужую ли едим
							if (move_b){
								if (arr_check[eat_x][eat_y]=="r"){
									//изменяем данные в массиве
									arr_check[arr_ox][arr_oy]="n";
									arr_check[eat_x][eat_y]="n";
									arr_check[arr_x][arr_y]="b";
									
									r_count--;
									//изменяем счет
									document.getElementById("inr").innerHTML='<font color="red">' + r_count+'</font>:<font color="black">' + b_count+"</font>";							
									//перемещаем шашку
									this.animate({r: 20, cx: x, cy: y}, 500, ">");
									//удаляем съеденную
									elem.remove();
									//если достигла конца доски, то становится дамкой
									if (arr_y==0||arr_y==line_count-1) {
										this.attr("stroke-width", "4"); 
										this.attr("stroke", "yellow"); 
									}
									//проверка. Остались ли шашки у противника (красных)
									if (r_count == 0) alert (" Game over. Black win");								
									return; //выход из функции
								} else { alert ("Нельзя есть свои"); this.animate({r: 20, cx: ox, cy: oy}, 500, ">"); return;}
							} else {
								if (arr_check[eat_x][eat_y]=="b"){
									//изменяем данные в массиве
									arr_check[arr_ox][arr_oy]="n";	
									arr_check[eat_x][eat_y]="n";
									arr_check[arr_x][arr_y]="r";
									
									b_count--;
									//изменяем счет
									document.getElementById("inr").innerHTML='<font color="red">' + r_count+'</font>:<font color="black">' + b_count+"</font>";
									//перемещаем шашку
									this.animate({r: 20, cx: x, cy: y}, 500, ">");
									//удаляем съеденную
									elem.remove();	
									//если достигла конца доски, то становится дамкой
									if (arr_y==0||arr_y==line_count-1) {
										this.attr("stroke-width", "4"); 
										this.attr("stroke", "yellow"); 
									}
									//проверка. Остались ли шашки у противника (черный)
									if (b_count == 0) alert (" Game over. Red win");									
									return; //выход из функции
								}else { 
									//если пытаемся съесть свою
									alert ("Нельзя есть свои"); 
									//перемещаем обратно откуда пошли
									this.animate({r: 20, cx: ox, cy: oy}, 500, ">"); 
									return; //выход из функции
								}
							}						
						}
						
						//ход на более чем одну ячейку
						if ((Math.abs(arr_oy-arr_y)>1||Math.abs(arr_ox-arr_x)>1)) {
							alert("Неверный ход");
							this.animate({r: 20, cx: ox, cy: oy}, 500, ">");
							return;
						}
						
						//ход назад запрещен
						if (this.attr("stroke")!="yellow"){ // если не дамка
							if (move_b & arr_oy-arr_y<0){
								alert("Шашки не ходят назад");							
								this.animate({r: 20, cx: ox, cy: oy}, 500, ">");	
								return;							
							}
						
							if (!move_b & arr_y-arr_oy<0){
								alert("Шашки не ходят назад");
								this.animate({r: 20, cx: ox, cy: oy}, 500, ">");
								return;							
							}
						}
						
						//перенос шашку на задний план
						this.toBack();
						
						//смена хода
						if (move_b) {
							move_b=false;
							arr_check[arr_x][arr_y]="b";
							
						}else {
							move_b=true;
							arr_check[arr_x][arr_y]="r";
						}
						
						//проверка достигла ли шашка конца, если да, то дамка
						if (arr_y==0||arr_y==line_count-1) {
								this.attr("stroke-width", "4"); 
								this.attr("stroke", "yellow"); 
								
						} 
						
						//обнуление клетки откуа пошли
						arr_check[arr_ox][arr_oy]="n";	
						//анимация передвижения шашки
						this.animate({r: 20, cx: x, cy: y}, 500, ">");
						
					} else { // если ходит вне очереди
						alert ("Не ваш ход");
						x=ox;
						y=oy;
						this.animate({r: 20, cx: x, cy: y}, 500, ">");
						return;
					}
                    this.animate({r: 20, cx: x, cy: y}, 500, ">");				
                };
				
				//событие перемещения красных 
	            stred.drag(move, start, up);
				////событие перемещения черных 
				stblack.drag(move, start, up);


		};

		


		
 </script>
 <div class="div-main">
	<div class="header">
		<table class="header-table">
			<tr>
				<td>
					Столбцы: <input id = "column" type="number" min="4" max="8" value="8" class="header-input"> 
				</td>
				<td>
					Строки: <input id = "line" type="number" min="4" max="8" value="8" class="header-input"> 
				</td>			
			</tr>
			<tr>
				<td colspan="2">
					<button id="generate" onclick = "generate_table()" class="header-button">Обновить доску</button> 
				</td>	
			</tr>
		</table>
		<div id="inr" class="n"></div>
	</div>
	<div class="center">					
        <div class="kont">
            <div id="desk" class="div-desk" ></div>
        </div>				 
     </div>
</div>
</body>
</html>